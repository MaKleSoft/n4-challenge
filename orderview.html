<link rel="import" href="bower_components/polymer/polymer.html">

<polymer-element name="n4-orderview" attributes="order taxes">
    <template>
        <style>
            .back {
                float: right;
            }
        </style>
        <h1>
            <button class="btn back" on-tap="{{ back }}">back</button>
            Order number: {{ order.number }}
        </h1>
        <table class="table">
            <tr>
                <th>Product Name</th>
                <th>Quantity</th>
                <th>Price each</th>
            </tr>
            <template repeat="{{ order.items }}">
                <tr>
                    <td>{{ product.name }}</td>
                    <td>{{ quantity}}</td>
                    <td>{{ product.price }}</td>
                </tr>
            </template>
        </table>
        <template repeat="{{ taxInfos }}">
            <h2>Taxes for {{ name }}</h2>
            <table class="table">
                <tr>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Tax</th>
                    <th>Price</th>
                </tr>
                <template repeat="{{ items }}">
                    <tr>
                        <td>{{ product.name }}</td>
                        <td>{{ quantity }}</td>
                        <td>{{ tax }}</td>
                        <td>{{ price }}</td>
                    </tr>
                </template>
                <tr>
                    <th colspan="3">Total</th>
                    <th>{{ total }}</th>
                </tr>
            </table>
        </template>
    </template>
    <script>
        Polymer("n4-orderview", {
            observe: {
                "order.items": "itemsChanged"
            },
            itemsChanged: function() {
                this.taxInfos = [];
                this.order.fetchProductDetails(this.fetchTaxes.bind(this));
            },
            fetchTaxes: function() {
                this.taxes.forEach(function(tax) {
                    tax.getTaxes(this.order, function(items) {
                        var total = items.reduce(function(sum, item) {
                            return sum + item.price;
                        }, 0);
                        this.taxInfos.push({
                            name: tax.name,
                            items: items,
                            total: total
                        });
                    }.bind(this));
                }.bind(this));
            },
            back: function() {
                this.fire("back");
            }
        });
    </script>
</polymer-element>